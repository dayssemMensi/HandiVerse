<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualisation Temps Réel</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      color: #333;
      margin: 0; padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      color: #2a7ae2;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .card-container {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 30px 40px;
      min-width: 200px;
      text-align: center;
      transition: box-shadow 0.3s ease;
      cursor: default;
    }
    .card:hover {
      box-shadow: 0 8px 20px rgb(0 0 0 / 0.15);
    }

    .card-title {
      font-size: 1.2rem;
      color: #555;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .card-title i {
      color: #2a7ae2;
      font-size: 1.4rem;
    }

    .card-value {
      font-size: 3rem;
      font-weight: 700;
      color: #1e3a8a;
    }

    .small-label {
      font-size: 0.85rem;
      color: #777;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    #graph {
      width: 90vw;
      max-width: 900px;
      height: 350px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
      margin-top: 20px;
    }
  </style>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h1><i class="fas fa-heartbeat"></i> Monitoring Cardiaque</h1>

  <div class="card-container">
    <div class="card" id="bpm-card">
      <div class="card-title"><i class="fas fa-heart"></i> Rythme Cardiaque</div>
      <div id="bpm" class="card-value">--</div>
      <div class="small-label">BPM</div>
    </div>

    <div class="card" id="fingers-card">
      <div class="card-title"><i class="fas fa-hand-paper"></i> Position Main</div>
      <div id="fingers" class="card-value">-----</div>
      <div class="small-label">État des doigts</div>
    </div>
  </div>

  <div id="graph"></div>
<script>
  const socket = io();

  let timeData = [];
  let bpmData = [];
  let fingerStatesHistory = [];

  // Configuration du layout avec plusieurs améliorations
  const layout = {
    title: { 
      text: 'Évolution du Rythme Cardiaque et des Doigts', 
      font: { size: 18, color: '#2c3e50' },
      x: 0.05,
      y: 0.95
    },
    margin: { l: 60, r: 40, t: 60, b: 60 },
    paper_bgcolor: '#f8f9fa',
    plot_bgcolor: '#f8f9fa',
    xaxis: {
      title: { text: 'Temps (s)', standoff: 15 },
      showgrid: true,
      gridcolor: '#e0e0e0',
      zeroline: false,
      tickfont: { size: 12, color: '#7f8c8d' },
      range: [0, 30] // Affiche les 30 dernières secondes
    },
    yaxis: {
      title: { text: 'BPM', standoff: 15 },
      range: [40, 180],
      showgrid: true,
      gridcolor: '#e0e0e0',
      zeroline: true,
      zerolinecolor: '#bdc3c7',
      tickfont: { size: 12, color: '#7f8c8d' }
    },
    yaxis2: {
      title: 'Doigts (0/1)',
      overlaying: 'y',
      side: 'right',
      range: [-0.1, 1.1],
      showgrid: false,
      tickvals: [0, 1],
      ticktext: ['Fermé', 'Ouvert']
    },
    hovermode: 'x unified',
    legend: {
      orientation: 'h',
      y: -0.2,
      font: { size: 12 }
    },
    shapes: [
      // Zone de BPM normal
      {
        type: 'rect',
        xref: 'paper',
        yref: 'y',
        x0: 0,
        y0: 60,
        x1: 1,
        y1: 100,
        fillcolor: 'rgba(46, 204, 113, 0.2)',
        line: { width: 0 }
      },
      // Zone d'alerte
      {
        type: 'rect',
        xref: 'paper',
        yref: 'y',
        x0: 0,
        y0: 100,
        x1: 1,
        y1: 180,
        fillcolor: 'rgba(231, 76, 60, 0.1)',
        line: { width: 0 }
      }
    ],
    annotations: [
      {
        x: 0.5,
        y: 80,
        xref: 'paper',
        yref: 'y',
        text: 'Zone normale',
        showarrow: false,
        font: { color: '#2ecc71', size: 10 }
      },
      {
        x: 0.5,
        y: 140,
        xref: 'paper',
        yref: 'y',
        text: 'Zone d\'alerte',
        showarrow: false,
        font: { color: '#e74c3c', size: 10 }
      }
    ]
  };

  // Traces pour les données
  const traces = [
    { // Trace BPM
      x: timeData,
      y: bpmData,
      name: 'BPM',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#3498db', width: 2.5, shape: 'spline' },
      marker: { size: 8, color: '#2980b9' },
      hoverinfo: 'y+name',
      yaxis: 'y1'
    },
    { // Trace moyenne mobile
      x: timeData,
      y: [],
      name: 'Moyenne (10s)',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#e67e22', width: 3, dash: 'dot' },
      hoverinfo: 'y+name',
      yaxis: 'y1'
    },
    { // Trace état des doigts
      x: timeData,
      y: [],
      name: 'Doigts',
      type: 'scatter',
      mode: 'markers',
      marker: { 
        size: 12,
        color: [],
        colorscale: [[0, '#e74c3c'], [1, '#2ecc71']],
        symbol: 'square'
      },
      hoverinfo: 'y+name',
      yaxis: 'y2'
    }
  ];

  Plotly.newPlot('graph', traces, layout, { responsive: true });

  // Fonction pour calculer la moyenne mobile
  function movingAverage(data, windowSize = 10) {
    return data.map((val, idx) => {
      const start = Math.max(0, idx - windowSize + 1);
      const subset = data.slice(start, idx + 1);
      return subset.reduce((a, b) => a + b, 0) / subset.length;
    });
  }

  socket.on('update', data => {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const seconds = now.getSeconds();
    
    if (data.bpm !== undefined && data.fingers !== undefined) {
      // Mise à jour des données
      timeData.push(seconds);
      bpmData.push(data.bpm);
      
      // Calcul du nombre de doigts ouverts
      const openFingers = data.fingers.split('').filter(d => d === '1').length;
      fingerStatesHistory.push(openFingers / 5); // Normalisé entre 0 et 1
      
      // Garder seulement les 30 dernières valeurs
      if (timeData.length > 30) {
        timeData.shift();
        bpmData.shift();
        fingerStatesHistory.shift();
      }
      
      // Calcul de la moyenne mobile
      const movingAvg = movingAverage(bpmData, 10);
      
      // Mise à jour du graphique
      Plotly.update('graph', {
        x: [timeData, timeData, timeData],
        y: [bpmData, movingAvg, fingerStatesHistory],
        'marker.color': [fingerStatesHistory.map(v => v > 0.5 ? 1 : 0)]
      }, {}, [0, 1, 2]);
      
      // Mise à jour des cartes
      document.getElementById('bpm').textContent = data.bpm;
      document.getElementById('fingers').textContent = data.fingers;
      
      // Animation si BPM élevé
      if (data.bpm > 120) {
        document.getElementById('bpm-card').style.animation = 'pulse 0.5s';
        setTimeout(() => {
          document.getElementById('bpm-card').style.animation = '';
        }, 500);
      }
    }
  });

  // Ajout du style pour l'animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
      100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }
    .card {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
  `;
  document.head.appendChild(style);
</script>

</body>
</html>
